<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Doraemon Inventory - Reset Password</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
      body { font-family: 'Poppins', sans-serif; }
    </style>
  </head>
  <body class="bg-gray-50">
    <div class="min-h-screen flex flex-col items-center justify-center py-6 px-4">
      <div class="max-w-md w-full">
        <div class="text-center mb-8">
          <h1 class="text-4xl font-extrabold text-purple-600">Doraemon Inventory</h1>
        </div>

        <div class="p-6 sm:p-8 rounded-2xl bg-white border border-gray-200 shadow-sm">
          <h1 class="text-slate-900 text-center text-3xl font-semibold mb-2" id="formTitle">Reset Password</h1>
          <p class="text-slate-500 text-center text-sm mb-8" id="formSubtitle">Enter your email to receive a reset link</p>

          <!-- Request reset: ask for email -->
          <form id="requestForm" class="request-form space-y-6">
            <div>
              <label class="text-slate-900 text-sm font-medium mb-2 block">Email Address</label>
              <div class="relative flex items-center">
                <input type="email" id="emailInput" required class="w-full text-slate-900 text-sm border border-slate-300 px-4 py-3 pr-10 rounded-md outline-blue-600 focus:ring-2 focus:ring-blue-500" placeholder="Enter your email" />
                <svg xmlns="http://www.w3.org/2000/svg" fill="#bbb" class="w-4 h-4 absolute right-4" viewBox="0 0 24 24">
                  <path d="M20 4H4c-1.1 0-1.99.9-1.99 2L2 18c0 1.1.9 2 2 2h16c1.1 0 2-.9 2-2V6c0-1.1-.9-2-2-2zm0 4l-8 5-8-5V6l8 5 8-5v2z"/>
                </svg>
              </div>
            </div>

            <div class="!mt-8">
              <button type="submit" class="w-full py-2 px-4 text-[15px] font-medium tracking-wide rounded-md text-white bg-blue-600 hover:bg-blue-700 focus:outline-none cursor-pointer transition-colors">
                Send Reset Link
              </button>
            </div>
            <p class="text-slate-900 text-sm !mt-6 text-center">
              <a href="login.html" class="text-blue-600 hover:underline font-semibold">Back to Login</a>
            </p>
          </form>

          <!-- Confirm reset: set new password (hidden until token present) -->
          <form id="confirmForm" class="confirm-form space-y-6" style="display:none;">
            <div>
              <label class="text-slate-900 text-sm font-medium mb-2 block">New Password</label>
              <div class="relative flex items-center">
                <input type="password" id="newPassword" required class="w-full text-slate-900 text-sm border border-slate-300 px-4 py-3 pr-10 rounded-md outline-blue-600 focus:ring-2 focus:ring-blue-500" placeholder="Enter new password" />
                <svg xmlns="http://www.w3.org/2000/svg" fill="#bbb" stroke="#bbb" class="w-4 h-4 absolute right-4 cursor-pointer" viewBox="0 0 128 128">
                  <path d="M64 104C22.127 104 1.367 67.496.504 65.943a4 4 0 0 1 0-3.887C1.367 60.504 22.127 24 64 24s62.633 36.504 63.496 38.057a4 4 0 0 1 0 3.887C126.633 67.496 105.873 104 64 104zM8.707 63.994C13.465 71.205 32.146 96 64 96c31.955 0 50.553-24.775 55.293-31.994C114.535 56.795 95.854 32 64 32 32.045 32 13.447 56.775 8.707 63.994zM64 88c-13.234 0-24-10.766-24-24s10.766-24 24-24 24 10.766 24 24-10.766 24-24 24zm0-40c-8.822 0-16 7.178-16 16s7.178 16 16 16 16-7.178 16-16-7.178-16-16-16z" data-original="#000000"></path>
                </svg>
              </div>
            </div>
            <div>
              <label class="text-slate-900 text-sm font-medium mb-2 block">Confirm Password</label>
              <div class="relative flex items-center">
                <input type="password" id="confirmPassword" required class="w-full text-slate-900 text-sm border border-slate-300 px-4 py-3 pr-10 rounded-md outline-blue-600 focus:ring-2 focus:ring-blue-500" placeholder="Confirm new password" />
                <svg xmlns="http://www.w3.org/2000/svg" fill="#bbb" stroke="#bbb" class="w-4 h-4 absolute right-4 cursor-pointer" viewBox="0 0 128 128">
                  <path d="M64 104C22.127 104 1.367 67.496.504 65.943a4 4 0 0 1 0-3.887C1.367 60.504 22.127 24 64 24s62.633 36.504 63.496 38.057a4 4 0 0 1 0 3.887C126.633 67.496 105.873 104 64 104zM8.707 63.994C13.465 71.205 32.146 96 64 96c31.955 0 50.553-24.775 55.293-31.994C114.535 56.795 95.854 32 64 32 32.045 32 13.447 56.775 8.707 63.994zM64 88c-13.234 0-24-10.766-24-24s10.766-24 24-24 24 10.766 24 24-10.766 24-24 24zm0-40c-8.822 0-16 7.178-16 16s7.178 16 16 16 16-7.178 16-16-7.178-16-16-16z" data-original="#000000"></path>
                </svg>
              </div>
            </div>

            <div class="!mt-8">
              <button type="submit" class="w-full py-2 px-4 text-[15px] font-medium tracking-wide rounded-md text-white bg-blue-600 hover:bg-blue-700 focus:outline-none cursor-pointer transition-colors">
                Reset Password
              </button>
            </div>
            <p class="text-slate-900 text-sm !mt-6 text-center">
              <a href="login.html" class="text-blue-600 hover:underline font-semibold">Back to Login</a>
            </p>
          </form>
        </div>
      </div>
    </div>

    <script>
      // Utility: read token from URL
      function getTokenFromUrl() {
        const params = new URLSearchParams(window.location.search);
        return params.get('token');
      }

      document.addEventListener('DOMContentLoaded', () => {
        const token = getTokenFromUrl();
        const requestForm = document.getElementById('requestForm');
        const confirmForm = document.getElementById('confirmForm');
        const formTitle = document.getElementById('formTitle');
        const formSubtitle = document.getElementById('formSubtitle');

        if (token) {
          // show confirm form
          requestForm.style.display = 'none';
          confirmForm.style.display = 'block';
          formTitle.textContent = 'Set New Password';
          formSubtitle.textContent = 'Enter your new password below';
        } else {
          requestForm.style.display = 'block';
          confirmForm.style.display = 'none';
          formTitle.textContent = 'Reset Password';
          formSubtitle.textContent = 'Enter your email to receive a reset link';
        }

        requestForm.addEventListener('submit', async (e) => {
          e.preventDefault();
          const email = document.getElementById('emailInput').value.trim();
          if (!email) { alert('Please enter your email'); return; }
          try {
            const res = await fetch('http://localhost:5000/api/auth/request-reset', {
              method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ email })
            });
            const data = await res.json();
            if (res.ok && data.success) {
              alert('Reset email sent. Check your inbox.');
            } else {
              alert(data.message || 'Failed to send reset email');
            }
          } catch (err) { console.error(err); alert('Cannot connect to server'); }
        });

        confirmForm.addEventListener('submit', async (e) => {
          e.preventDefault();
          const newPassword = document.getElementById('newPassword').value.trim();
          const confirmPassword = document.getElementById('confirmPassword').value.trim();
          if (!newPassword || !confirmPassword) { alert('Please fill all fields'); return; }
          if (newPassword !== confirmPassword) { alert('Passwords do not match'); return; }
          try {
            const res = await fetch('http://localhost:5000/api/auth/confirm-reset', {
              method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ token, newPassword })
            });
            const data = await res.json();
            if (res.ok && data.success) {
              alert('Password updated successfully. Redirecting to login...');
              window.location.href = 'login.html';
            } else {
              alert(data.message || 'Failed to update password');
            }
          } catch (err) { console.error(err); alert('Cannot connect to server'); }
        });
      });
    </script>
  </body>
</html>