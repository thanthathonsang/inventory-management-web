<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link rel="stylesheet" href="assets/css/style.css" />
    <!-- BOX ICONS -->
    <link href="https://cdn.jsdelivr.net/npm/boxicons@2.0.5/css/boxicons.min.css" rel="stylesheet" />
    <title>Reset Password</title>
  </head>
  <body>
    <div class="l-form">
      <div class="shape1"></div>
      <div class="shape2"></div>

      <div class="form">
        <img src="assets/img/authentication.svg" alt="" class="form__img" />

        <div class="form__content">
          <h1 class="form__title" id="formTitle">Reset Password</h1>

          <!-- Request reset: ask for email -->
          <form id="requestForm" class="request-form">
            <div class="form__div form__div-one">
              <div class="form__icon"><i class="bx bx-envelope"></i></div>
              <div class="form__div-input">
                <label class="form__label">Email</label>
                <input type="email" id="emailInput" class="form__input" required />
              </div>
            </div>
            <input type="submit" class="form__button" value="Send Reset Email" />
            <p style="text-align:center;margin-top:.5rem;"><a href="login.html">Back to Login</a></p>
          </form>

          <!-- Confirm reset: set new password (hidden until token present) -->
          <form id="confirmForm" class="confirm-form" style="display:none;">
            <div class="form__div">
              <div class="form__icon"><i class="bx bx-lock"></i></div>
              <div class="form__div-input">
                <label class="form__label">New Password</label>
                <input type="password" id="newPassword" class="form__input" required />
              </div>
            </div>
            <div class="form__div">
              <div class="form__icon"><i class="bx bx-lock"></i></div>
              <div class="form__div-input">
                <label class="form__label">Confirm Password</label>
                <input type="password" id="confirmPassword" class="form__input" required />
              </div>
            </div>
            <input type="submit" class="form__button" value="Change Password" />
            <p style="text-align:center;margin-top:.5rem;"><a href="login.html">Back to Login</a></p>
          </form>
        </div>
      </div>
    </div>

    <!-- main JS (handles input focus) -->
    <script src="assets/js/main.js"></script>

    <script>
      // Utility: read token from URL
      function getTokenFromUrl() {
        const params = new URLSearchParams(window.location.search);
        return params.get('token');
      }

      document.addEventListener('DOMContentLoaded', () => {
        const token = getTokenFromUrl();
        const requestForm = document.getElementById('requestForm');
        const confirmForm = document.getElementById('confirmForm');
        const formTitle = document.getElementById('formTitle');

        if (token) {
          // show confirm form
          requestForm.style.display = 'none';
          confirmForm.style.display = 'block';
          formTitle.textContent = 'Set a New Password';
        } else {
          requestForm.style.display = 'block';
          confirmForm.style.display = 'none';
          formTitle.textContent = 'Reset Password';
        }

        requestForm.addEventListener('submit', async (e) => {
          e.preventDefault();
          const email = document.getElementById('emailInput').value.trim();
          if (!email) { alert('Please enter your email'); return; }
          try {
            const res = await fetch('http://localhost:5000/api/auth/request-reset', {
              method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ email })
            });
            const data = await res.json();
            if (res.ok && data.success) {
              alert('Reset email sent. Check your inbox.');
            } else {
              alert(data.message || 'Failed to send reset email');
            }
          } catch (err) { console.error(err); alert('Cannot connect to server'); }
        });

        confirmForm.addEventListener('submit', async (e) => {
          e.preventDefault();
          const newPassword = document.getElementById('newPassword').value.trim();
          const confirmPassword = document.getElementById('confirmPassword').value.trim();
          if (!newPassword || !confirmPassword) { alert('Please fill all fields'); return; }
          if (newPassword !== confirmPassword) { alert('Passwords do not match'); return; }
          try {
            const res = await fetch('http://localhost:5000/api/auth/confirm-reset', {
              method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ token, newPassword })
            });
            const data = await res.json();
            if (res.ok && data.success) {
              alert('Password updated successfully. Redirecting to login...');
              window.location.href = 'login.html';
            } else {
              alert(data.message || 'Failed to update password');
            }
          } catch (err) { console.error(err); alert('Cannot connect to server'); }
        });
      });
    </script>
  </body>
</html>